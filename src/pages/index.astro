---
import Layout from "@layout";
import { authStore } from "@stores/auth";
import PostCard from "@components/post-card.astro";
import IconSearch from "@icons/search.astro";
import IconUser from "@icons/user.astro";
import BubblePlus from "@icons/bubble-plus.astro";
import { getPosts } from "@services/api";
import IconLeft from "@icons/toggle-left.astro";

if (!Astro.cookies.get("session")) {
  await authStore.set({
    userLogged: null,
    errors: { message: "Session expired!" },
  });
  return Astro.redirect("/login");
}

const { userLogged } = await authStore.get();

const avatarSrc = userLogged?.avatar[0].secureUrl;

const posts = await getPosts(15).catch((err) => {
  console.log(err);
  return [];
});
---

<Layout page="Home" description="">
  <section class="home">
    <header class="home__header">
      <h1 class="home__header__h1" transition:name="ask">Ask!</h1>

      <ul class="home__header__ul">
        <li>
          <a class="home__header__btn" href="/search">
            <IconSearch /> Search
          </a>
        </li>
        <li>
          <a class="home__header__btn" href="/profile">
            <IconUser /> Profile
          </a>
        </li>
      </ul>

      <button class="home__header__btn--session" title="Close session?">
        <img
          src={avatarSrc}
          alt={userLogged?.name}
          loading="lazy"
          class="home__header_avatar"
          transition:name="avatar"
        />
      </button>
    </header>

    <div class="home__container">
      <ul>
        <li>
          <a href=`/settings/${userLogged?._id}`>Settings</a>
        </li>
        <li>
          <button id="theme-btn">
            <IconLeft />
          </button>
        </li>
        <li></li>
      </ul>

      <div class="home__container--posts">
        {
          posts?.length !== 0 ? (
            posts.map((post) => <PostCard post={post} />)
          ) : (
            <span class="home__container--alert">There is no news here!</span>
          )
        }

        <a
          href="/post/add"
          class="home__btn--add-post"
          title="Share how your feels today!"
        >
          <BubblePlus />
        </a>
      </div>
    </div>
  </section>
</Layout>

<script>
  const $themeBtn = document.querySelector("#theme-btn");
  const $body = document.querySelector("body");
  $themeBtn.addEventListener("click", () => {
    const themeSaved = localStorage.getItem("theme");

    if (!themeSaved) {
      const theme = "dark";
      $body.style.backgroundColor = "#111";
      $body.style.color = "#fff";
      return localStorage.setItem("theme", theme);
    }

    if (themeSaved === "light") {
      const theme = "dark";
      $body.style.backgroundColor = "#111";
      $body.style.color = "#fff";

      return localStorage.setItem("theme", theme);
    }

    if (themeSaved === "dark") {
      const theme = "light";
      $body.style.backgroundColor = "#fff";
      $body.style.color = "#111";

      return localStorage.setItem("theme", theme);
    }
  });
</script>
<style>
  .home {
    position: relative;
    min-height: 100dvh;
    display: flex;
    flex-flow: column;
  }
  .home__header {
    max-width: 1200px;
    width: 100%;
    margin: 0 auto;
    display: flex;
    align-items: center;
    padding: 4px 6px;
    border-bottom: 1px solid var(--color_secondary);
    border-radius: var(--padding_boxes);
  }
  .home__header__h1 {
    color: var(--color_accent);
    pointer-events: none;
  }
  .home__header__ul {
    flex: 1;
    display: flex;
    justify-content: space-around;
    align-items: center;
  }
  .home__header__btn {
    color: var(--color_secondary_text);
    display: flex;
    align-items: self-end;
    gap: 2px;
    box-shadow: 0 0 0 transparent;
    border-radius: var(--border_size);
    padding: 2px;
    transition: box-shadow 0.1s ease-in-out;
    &:hover {
      box-shadow: 0 4px 2px var(--color_secondary);
    }
    &:active {
      box-shadow: 0 2px 2px var(--color_secondary);
    }
  }
  .home__header__btn--session {
    display: flex;
    background: none;
    border: 1px solid var(--color_accent_light);
    border-radius: 100%;
    overflow: hidden;
    cursor: pointer;
    box-shadow: 0 0 5px var(--color_accent);
    transition: box-shadow 0.2s ease-in;

    &:hover {
      box-shadow: 0 4px 5px var(--color_accent);
    }
    &:active {
      box-shadow: 0 1px 5px var(--color_accent);
    }

    & > img {
      aspect-ratio: 4 / 4;
      object-fit: cover;
      object-position: center;
    }
  }
  .home__container {
    display: flex;
  }
  .home__container--posts {
    position: relative;
    flex: 1;
    max-width: calc(var(--max_w) - 200px);
    width: 100%;
    height: calc(100dvh - 66px);
    margin: 0 auto;
    overflow-y: scroll;
    border-left: 1px solid var(--color_secondary);
    border-right: 1px solid var(--color_secondary);
    text-align: center;
    &::-webkit-scrollbar {
      display: none;
    }

    .home__container--alert {
      font-size: xx-large;
    }
  }

  .home__btn--add-post {
    position: fixed;
    width: 100%;
    height: 100%;
    max-height: 80px;
    max-width: 80px;
    display: flex;
    justify-content: center;
    bottom: 10%;
    right: 5%;
    border: 3px solid var(--color_accent);
    background-color: var(--color_accent_light);
    border-radius: 100%;
    box-shadow: inset 0 0 8px transparent;
    transition: box-shadow 0.2s ease-out;
    color: var(--color_secondary_text);
  }
</style>
