---
import Layout from "@layout";
import { authStore } from "@stores/auth";
import PostCard from "@components/post-card.astro";
import ApiFn from "@services/api";
import { postsStore } from "@stores/posts";
import { COOKIE } from "@const";

if (!Astro.cookies.get(COOKIE.name) || authStore.get().userLogged === null) {
  authStore.set({
    userLogged: null,
    errors: { message: "Session expired!" },
  });
  postsStore.set([]);
  return Astro.redirect("/login");
}

if (postsStore.get().length === 0) {
  const posts = await ApiFn(Astro.url.origin).getPosts(20);
  postsStore.set([...posts]);
  console.log("fetched from server");
}

const posts = postsStore.get();

console.log("fetched from store");
---

<Layout page="Home" description="">
  <section class="home">
    <div class="home__container">
      <div class="home__container--posts">
        {
          posts?.length !== 0 ? (
            posts.map((post) => <PostCard post={post} />)
          ) : (
            <span class="home__container--alert">There is no news here!</span>
          )
        }
      </div>
    </div>
  </section>
</Layout>
<style>
  .home {
    position: relative;
    min-height: 100dvh;

    display: flex;
    flex-flow: row;
    justify-content: center;
  }

  .home__container {
    position: relative;

    display: flex;
  }
  .home__container--posts {
    position: relative;
    flex: 1;
    max-width: calc(var(--max_w) - 200px);
    width: 100%;
    height: 100dvh;
    margin: 0 auto;
    overflow-y: scroll;
    overflow-x: hidden;
    border-left: 1px solid var(--color_secondary);
    border-right: 1px solid var(--color_secondary);
    text-align: center;
    &::-webkit-scrollbar {
      display: none;
    }

    .home__container--alert {
      font-size: xx-large;
    }
  }
</style>
